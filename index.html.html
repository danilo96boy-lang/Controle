<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro - Casal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        :root { --bg: #111827; --card: #1f2937; --primary: #6366f1; --text: #f9fafb; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; }
        
        /* Loader e Tabs */
        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tab-btn { padding: 10px 20px; border-bottom: 2px solid transparent; opacity: 0.6; transition: 0.3s; font-size: 1.1rem; font-weight: 600; }
        .tab-btn.active { border-color: var(--primary); opacity: 1; color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .expense-item:hover { background-color: #374151; transform: translateX(5px); }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 md:p-8">

    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-sm border border-gray-700 shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center">Acesso Financeiro</h2>
            <form id="login-form" class="space-y-4">
                <input type="text" id="user" placeholder="Usu√°rio" class="w-full p-3 bg-gray-900 border border-gray-600 rounded text-white focus:border-indigo-500 outline-none">
                <input type="password" id="pass" placeholder="Senha" class="w-full p-3 bg-gray-900 border border-gray-600 rounded text-white focus:border-indigo-500 outline-none">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded font-bold transition">Entrar</button>
            </form>
            <p id="login-msg" class="text-red-400 text-center mt-4 hidden text-sm">Dados incorretos.</p>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-white font-medium">Processando...</p>
    </div>

    <div id="app-container" class="max-w-6xl mx-auto w-full opacity-0 transition-opacity duration-700 hidden">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Painel Financeiro</h1>
                <p class="text-gray-400">Bem-vindo, <span id="user-display" class="text-indigo-400 font-bold capitalize"></span></p>
            </div>
            <div class="flex items-center bg-gray-800 rounded-full px-4 py-2 border border-gray-700 shadow-lg">
                <button id="prev-month" class="p-2 hover:text-indigo-400">‚óÄ</button>
                <span id="current-month" class="mx-4 font-bold min-w-[140px] text-center capitalize text-lg"></span>
                <button id="next-month" class="p-2 hover:text-indigo-400">‚ñ∂</button>
            </div>
        </header>

        <div class="flex gap-4 border-b border-gray-700 mb-6">
            <button class="tab-btn active" onclick="switchTab('geral')">Vis√£o Geral (Manual)</button>
            <button class="tab-btn" onclick="switchTab('cartao')">Cart√£o de Cr√©dito</button>
        </div>

        <div id="tab-geral" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="space-y-6">
                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg">
                        <h3 class="text-sm font-bold text-gray-400 uppercase mb-3">Renda Mensal</h3>
                        <div class="space-y-3">
                            <input type="number" id="income1" placeholder="Renda Gabi" class="w-full bg-gray-900 border border-gray-600 rounded p-2">
                            <input type="number" id="income2" placeholder="Renda Danilo" class="w-full bg-gray-900 border border-gray-600 rounded p-2">
                        </div>
                    </div>
                    <div id="summary-display" class="space-y-3"></div>
                </div>

                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700 h-[600px] flex flex-col shadow-lg">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                        <h3 class="font-bold text-xl">Gastos Manuais (Pix/D√©bito)</h3>
                        <button onclick="addManual()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-sm font-bold shadow transition">+ Novo Gasto</button>
                    </div>
                    <div id="manual-list" class="flex-1 overflow-y-auto pr-2 space-y-2"></div>
                </div>
            </div>
        </div>

        <div id="tab-cartao" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="space-y-6">
                    <div class="bg-gray-800 p-6 rounded-xl border-2 border-dashed border-indigo-500/50 text-center hover:border-indigo-500 transition cursor-pointer relative group">
                        <input type="file" id="pdf-upload" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="application/pdf">
                        <div class="text-4xl mb-2 group-hover:scale-110 transition">üìÑ</div>
                        <h3 class="font-bold text-lg text-white">Importar Fatura PDF</h3>
                        <p class="text-sm text-gray-400 mt-1">Arraste ou clique para selecionar</p>
                        <p class="text-xs text-indigo-400 mt-2 font-medium">Compat√≠vel com seu modelo (DD/MM)</p>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                        <h4 class="text-center font-bold text-gray-400 mb-3 text-sm">Categorias da Fatura</h4>
                        <div class="relative h-56"><canvas id="cardChart"></canvas></div>
                        <p id="card-total" class="text-center font-bold text-xl text-white mt-4">R$ 0,00</p>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700 h-[600px] flex flex-col shadow-lg">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                        <h3 class="font-bold text-xl">Lan√ßamentos da Fatura</h3>
                        <button onclick="clearInvoice()" class="text-red-400 hover:text-red-300 text-sm hover:underline">Limpar Importa√ß√£o</button>
                    </div>
                    <div id="invoice-list" class="flex-1 overflow-y-auto pr-2 space-y-2">
                        <div class="h-full flex flex-col items-center justify-center text-gray-500">
                            <p>Nenhuma fatura importada.</p>
                            <p class="text-sm opacity-60">Fa√ßa o upload do PDF ao lado.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/80 hidden z-50 items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md border border-gray-600 shadow-2xl transform transition-all scale-100">
            <h3 class="text-xl font-bold mb-4">Editar Lan√ßamento</h3>
            <form id="edit-form" class="space-y-3">
                <label class="text-xs text-gray-400">Data</label>
                <input type="date" id="edit-date" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none">
                
                <label class="text-xs text-gray-400">Descri√ß√£o</label>
                <input type="text" id="edit-desc" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none">
                
                <label class="text-xs text-gray-400">Categoria</label>
                <select id="edit-cat" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none"></select>
                
                <label class="text-xs text-gray-400">Valor (R$)</label>
                <input type="number" step="0.01" id="edit-val" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none">
                
                <div class="flex justify-between pt-4 border-t border-gray-700 mt-4">
                    <button type="button" onclick="deleteItem()" class="text-red-500 font-bold hover:text-red-400">Excluir</button>
                    <div class="flex gap-2">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 rounded font-bold hover:bg-indigo-500">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ïES ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBf1nzx6mH1lWckWQyXDnWZKLlh-5cfcv0",
            authDomain: "controle-a9909.firebaseapp.com",
            projectId: "controle-a9909",
            storageBucket: "controle-a9909.appspot.com",
            messagingSenderId: "43886457318",
            appId: "1:43886457318:web:289e82579a38c28fefa627"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const userId = 'casal_principal';

        const USERS = { 'gabi': '19071996', 'danilo': '08042020' };
        const CATEGORIES = ['Mercado', 'Contas', 'Apartamento', 'Carro', 'Lazer', 'Delivery', 'Posto', 'Farm√°cia', 'Roupa', 'Escola', 'Poupan√ßa Maria Luisa', 'Reserva', 'Uber/Transporte', 'Assinaturas', 'Outros'];
        const CATEGORY_COLORS = { 'Mercado': '#f59e0b', 'Contas': '#10b981', 'Apartamento': '#a855f7', 'Carro': '#3b82f6', 'Lazer': '#ef4444', 'Delivery': '#d946ef', 'Posto': '#ea580c', 'Farm√°cia': '#84cc16', 'Roupa': '#6366f1', 'Escola': '#0ea5e9', 'Uber/Transporte': '#64748b', 'Assinaturas': '#a855f7', 'Outros': '#6b7280' };

        // Palavras-chave para auto-classifica√ß√£o (Baseado na sua fatura)
        const KEYWORDS = {
            'uber': 'Uber/Transporte', '99': 'Uber/Transporte', 'sem parar': 'Carro',
            'ifood': 'Delivery', 'rappi': 'Delivery', 'mc donalds': 'Lazer', 'burger': 'Lazer',
            'netflix': 'Assinaturas', 'spotify': 'Assinaturas', 'amazon': 'Assinaturas', 'apple': 'Assinaturas', 'vivo': 'Contas', 'claro': 'Contas',
            'carrefour': 'Mercado', 'atacadao': 'Mercado', 'pague m': 'Mercado', 'roldao': 'Mercado', 'tenda': 'Mercado', 'comercial de alimentos': 'Mercado',
            'drogaria': 'Farm√°cia', 'farmacia': 'Farm√°cia', 'drogal': 'Farm√°cia',
            'posto': 'Posto', 'shell': 'Posto', 'ipiranga': 'Posto', 'adega': 'Lazer', 'airbnb': 'Lazer'
        };

        let expenses = [];
        let incomeData = {};
        let currentDate = new Date();
        let currentEditId = null;
        let chartInstance = null;

        // --- SISTEMA ---
        function init() {
            const sel = document.getElementById('edit-cat');
            sel.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            loadData();
        }

        // Login
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value.trim();
            if(USERS[u] && USERS[u] === p) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                setTimeout(() => document.getElementById('app-container').classList.remove('opacity-0'), 50);
                document.getElementById('user-display').innerText = u;
                init();
            } else {
                document.getElementById('login-msg').classList.remove('hidden');
            }
        };

        // Dados
        async function loadData() {
            toggleLoader(true);
            try {
                const snap = await db.collection('users').doc(userId).collection('expenses').get();
                expenses = snap.docs.map(d => ({id: d.id, ...d.data()}));
                const incSnap = await db.collection('users').doc(userId).collection('income').get();
                incomeData = {};
                incSnap.forEach(d => incomeData[d.id] = d.data());
                render();
            } catch(e) { console.error(e); alert("Erro ao carregar dados."); }
            toggleLoader(false);
        }

        function render() {
            const monthKey = currentDate.toISOString().slice(0, 7);
            document.getElementById('current-month').innerText = currentDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});

            const curExpenses = expenses.filter(e => e.date.startsWith(monthKey));
            const manual = curExpenses.filter(e => e.source === 'manual').sort((a,b) => new Date(b.date) - new Date(a.date));
            const invoice = curExpenses.filter(e => e.source === 'invoice').sort((a,b) => new Date(a.date) - new Date(b.date));

            // Renda
            const inc = incomeData[monthKey] || {s1:'', s2:''};
            document.getElementById('income1').value = inc.s1;
            document.getElementById('income2').value = inc.s2;

            // Totais
            const totManual = manual.reduce((a,b) => a + b.value, 0);
            const totInvoice = invoice.reduce((a,b) => a + b.value, 0);
            const totIncome = (parseFloat(inc.s1)||0) + (parseFloat(inc.s2)||0);
            const balance = totIncome - (totManual + totInvoice);

            document.getElementById('summary-display').innerHTML = `
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center"><span>Total Renda</span><span class="font-bold text-green-400">${fmtMoney(totIncome)}</span></div>
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center"><span>Sa√≠das Manuais</span><span class="font-bold text-red-400">${fmtMoney(totManual)}</span></div>
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center"><span>Fatura Cart√£o</span><span class="font-bold text-orange-400">${fmtMoney(totInvoice)}</span></div>
                <div class="bg-indigo-900/50 p-4 rounded border border-indigo-500/30 flex justify-between items-center text-lg mt-2"><span>Saldo</span><span class="font-bold ${balance>=0?'text-green-300':'text-red-300'}">${fmtMoney(balance)}</span></div>
            `;

            document.getElementById('card-total').innerText = fmtMoney(totInvoice);

            // Listas
            renderList(manual, 'manual-list', false);
            renderList(invoice, 'invoice-list', true);
            
            // Gr√°fico
            updateChart(invoice);
        }

        function renderList(list, elId, isInvoice) {
            const el = document.getElementById(elId);
            el.innerHTML = '';
            if(!list.length) {
                if(!isInvoice) el.innerHTML = '<div class="text-center text-gray-500 py-10">Sem gastos manuais neste m√™s.</div>';
                return;
            }
            list.forEach(item => {
                const day = item.date.split('-')[2];
                const color = CATEGORY_COLORS[item.category] || '#6b7280';
                el.innerHTML += `
                    <div onclick="openEdit('${item.id}')" class="expense-item bg-gray-700/50 p-3 rounded-lg flex items-center justify-between border-l-4 transition-all cursor-pointer mb-2" style="border-color: ${color}">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="bg-gray-800 w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold text-gray-400 shrink-0">${day}</div>
                            <div class="min-w-0">
                                <p class="font-bold text-sm text-white truncate">${item.description}</p>
                                <p class="text-xs text-gray-400">${item.category}</p>
                            </div>
                        </div>
                        <span class="font-bold text-white whitespace-nowrap ml-2">${fmtMoney(item.value)}</span>
                    </div>
                `;
            });
        }

        // --- IMPORTA√á√ÉO PDF ---
        document.getElementById('pdf-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            toggleLoader(true);
            try {
                const buff = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buff).promise;
                let items = [];
                const year = currentDate.getFullYear();
                const monthStr = String(currentDate.getMonth()+1).padStart(2,'0');

                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    // Junta todo texto com espa√ßo para facilitar regex global
                    const text = content.items.map(s => s.str).join(' ');

                    // REGEX AJUSTADO PARA SEU PDF (DD/MM Descri√ß√£o Valor)
                    // Captura: 14/07 POSTO AVENIDA 125,16
                    // Ignora linhas que parecem totais ou pagamentos
                    const regex = /(\d{2}\/\d{2})\s+(.*?)\s+(-?[\d\.]*?[\d]+,\d{2})/gi;
                    
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        const dayMonth = match[1]; // 14/07
                        const desc = match[2].trim();
                        const valStr = match[3];

                        // Filtros de seguran√ßa
                        if(desc.toUpperCase().includes('PAGAMENTO') || desc.toUpperCase().includes('SALDO')) continue;
                        if(desc.length < 3) continue;

                        // Valor
                        const val = parseFloat(valStr.replace('.','').replace(',','.'));
                        
                        // Data (Usa o ano da visualiza√ß√£o atual + dia/mes capturado)
                        // Aten√ß√£o: Se a fatura √© de Agosto, mas tem compras de Julho, vamos respeitar o m√™s da compra
                        const [d, m] = dayMonth.split('/');
                        const dateIso = `${year}-${m}-${d}`;

                        // Categoria Autom√°tica
                        let cat = 'Outros';
                        const low = desc.toLowerCase();
                        for(const [k, v] of Object.entries(KEYWORDS)) {
                            if(low.includes(k)) { cat = v; break; }
                        }

                        items.push({
                            date: dateIso,
                            description: desc,
                            value: val,
                            category: cat,
                            source: 'invoice' // Marca como fatura
                        });
                    }
                }

                if(items.length) {
                    const batch = db.batch();
                    items.forEach(it => {
                        const ref = db.collection('users').doc(userId).collection('expenses').doc();
                        batch.set(ref, it);
                    });
                    await batch.commit();
                    alert(`${items.length} itens importados com sucesso!`);
                    loadData();
                } else {
                    alert("Nenhum item reconhecido. Verifique se o PDF √© leg√≠vel.");
                }
            } catch(err) { console.error(err); alert("Erro ao ler PDF."); }
            
            toggleLoader(false);
            e.target.value = ''; // Limpa input
        });

        // --- CRUD E UTIL ---
        function addManual() {
            const desc = prompt("Descri√ß√£o:"); if(!desc) return;
            const val = parseFloat(prompt("Valor:")); if(isNaN(val)) return;
            db.collection('users').doc(userId).collection('expenses').add({
                date: currentDate.toISOString().split('T')[0],
                description: desc, value: val, category: 'Outros', source: 'manual'
            }).then(loadData);
        }

        function openEdit(id) {
            currentEditId = id;
            const it = expenses.find(e => e.id === id);
            document.getElementById('edit-date').value = it.date;
            document.getElementById('edit-desc').value = it.description;
            document.getElementById('edit-cat').value = it.category;
            document.getElementById('edit-val').value = it.value;
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        document.getElementById('edit-form').onsubmit = async (e) => {
            e.preventDefault();
            await db.collection('users').doc(userId).collection('expenses').doc(currentEditId).update({
                date: document.getElementById('edit-date').value,
                description: document.getElementById('edit-desc').value,
                category: document.getElementById('edit-cat').value,
                value: parseFloat(document.getElementById('edit-val').value)
            });
            closeModal(); loadData();
        };

        async function deleteItem() {
            if(confirm("Excluir?")) {
                await db.collection('users').doc(userId).collection('expenses').doc(currentEditId).delete();
                closeModal(); loadData();
            }
        }

        async function clearInvoice() {
            if(!confirm("Deseja apagar TODOS os itens importados da fatura deste m√™s?")) return;
            toggleLoader(true);
            const monthKey = currentDate.toISOString().slice(0, 7);
            const toDel = expenses.filter(e => e.date.startsWith(monthKey) && e.source === 'invoice');
            const batch = db.batch();
            toDel.forEach(e => batch.delete(db.collection('users').doc(userId).collection('expenses').doc(e.id)));
            await batch.commit();
            loadData();
        }

        async function saveIncome() {
            const mk = currentDate.toISOString().slice(0, 7);
            await db.collection('users').doc(userId).collection('income').doc(mk).set({
                s1: document.getElementById('income1').value, s2: document.getElementById('income2').value
            }, {merge:true});
        }
        document.getElementById('income1').onchange = saveIncome;
        document.getElementById('income2').onchange = saveIncome;

        function updateChart(data) {
            const ctx = document.getElementById('cardChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const cats = {};
            data.forEach(d => cats[d.category] = (cats[d.category]||0) + d.value);
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats), backgroundColor: Object.keys(cats).map(k=>CATEGORY_COLORS[k]||'#666'), borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff', font: {size: 10} } } } }
            });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleLoader(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
        function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); document.getElementById('edit-modal').classList.remove('flex'); }
        function fmtMoney(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }

        document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); loadData(); };
        document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); loadData(); };
    </script>
</body>
</html>
