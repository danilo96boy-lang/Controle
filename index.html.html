<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinancePro Enterprise</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        // Paleta "Dark Blue/Gray" Corporativa Profunda
                        bg: { main: '#0b0f19', card: '#111827', darker: '#030712' },
                        surface: { 100: '#1f2937', 200: '#374151', 300: '#4b5563' },
                        primary: { DEFAULT: '#3b82f6', glow: 'rgba(59, 130, 246, 0.5)' },
                        accent: { purple: '#8b5cf6', green: '#10b981', red: '#ef4444' }
                    }
                }
            }
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        body { background-color: #0b0f19; color: #f3f4f6; font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* --- ESTILO DOS INPUTS (CORRIGIDO) --- */
        /* Remove o fundo branco padr√£o e aplica estilo Dark Glass */
        .input-modern {
            background-color: rgba(31, 41, 55, 0.6); /* Gray 800 com transpar√™ncia */
            border: 1px solid #374151; /* Borda sutil */
            color: #ffffff;
            border-radius: 0.5rem;
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            outline: none;
        }
        .input-modern:focus {
            border-color: #3b82f6;
            background-color: rgba(31, 41, 55, 0.9);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Placeholder mais claro */
        .input-modern::placeholder { color: #6b7280; }

        /* Wrapper para Input com √çcone/S√≠mbolo (R$) */
        .input-group { position: relative; display: flex; align-items: center; }
        .input-prefix { 
            position: absolute; 
            left: 12px; 
            color: #9ca3af; 
            font-weight: 600; 
            font-size: 0.9rem;
            pointer-events: none;
        }
        .input-with-prefix { padding-left: 2.5rem !important; font-weight: 600; letter-spacing: 0.025em; }

        /* Cart√µes */
        .card {
            background-color: #111827; /* Gray 900 */
            border: 1px solid #1f2937; /* Gray 800 */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        /* Bot√µes */
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.6rem 1.2rem;
            transition: transform 0.1s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover { box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .btn-primary:active { transform: scale(0.98); }

        .btn-secondary {
            background-color: #1f2937;
            color: #e5e7eb;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            padding: 0.6rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-secondary:hover { background-color: #374151; }

        /* Scrollbar Invis√≠vel mas funcional */
        .scroll-hidden::-webkit-scrollbar { width: 6px; }
        .scroll-hidden::-webkit-scrollbar-track { background: transparent; }
        .scroll-hidden::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .scroll-hidden::-webkit-scrollbar-thumb:hover { background: #4b5563; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #0b0f19; z-index: 999; display: flex; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #1f2937; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Barra Animada */
        .bar-stripes { background-image: linear-gradient(45deg,rgba(255,255,255,.1) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.1) 50%,rgba(255,255,255,.1) 75%,transparent 75%,transparent); background-size: 1rem 1rem; animation: move 1s linear infinite; }
        @keyframes move { from { background-position: 1rem 0; } to { background-position: 0 0; } }
    </style>
</head>
<body>

    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0b0f19]">
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-[#0b0f19] to-[#0b0f19]"></div>
        
        <div class="relative card p-8 w-full max-w-sm border-t-4 border-t-blue-500 shadow-2xl">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-white tracking-tight">Finance<span class="text-blue-500">Pro</span></h1>
                <p class="text-gray-500 text-xs uppercase tracking-widest mt-1">Enterprise Access</p>
            </div>
            <form id="login-form" class="space-y-5">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Usu√°rio</label>
                    <input type="text" id="user" class="input-modern text-center" placeholder="Digite seu usu√°rio">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 ml-1 uppercase">Senha</label>
                    <input type="password" id="pass" class="input-modern text-center" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button type="submit" class="btn-primary w-full py-3 shadow-lg">ACESSAR PAINEL</button>
            </form>
            <p id="login-msg" class="text-red-400 text-center mt-4 text-sm hidden font-bold bg-red-900/20 py-2 rounded">Acesso Negado.</p>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <div id="app" class="flex h-screen opacity-0 transition-opacity duration-500 hidden">
        
        <aside class="w-64 bg-[#111827] border-r border-gray-800 flex-col hidden md:flex z-20">
            <div class="h-16 flex items-center px-6 border-b border-gray-800">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center mr-3 font-bold text-white shadow-lg shadow-blue-500/30">F</div>
                <span class="font-bold text-lg text-white">Finance<span class="text-blue-400">Pro</span></span>
            </div>
            <nav class="p-4 space-y-2 flex-1">
                <a href="#" class="flex items-center px-4 py-3 text-sm font-semibold bg-blue-600/10 text-blue-400 border border-blue-600/20 rounded-lg">
                    <span class="mr-3">üìä</span> Vis√£o Geral
                </a>
            </nav>
            <div class="p-4 bg-[#0f1420] border-t border-gray-800">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-sm font-bold text-white border border-gray-600 shadow" id="avatar-initial">U</div>
                    <div class="ml-3 overflow-hidden">
                        <p class="text-sm font-bold text-white capitalize truncate" id="user-name">Usu√°rio</p>
                        <p class="text-[10px] text-green-500 font-bold uppercase">‚óè Online</p>
                    </div>
                    <button id="logout-btn" class="ml-auto text-gray-500 hover:text-red-400 transition" title="Sair">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    </button>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative overflow-hidden">
            <header class="h-16 bg-[#111827] border-b border-gray-800 flex items-center justify-between px-6 shadow-sm z-10 shrink-0">
                <h2 class="text-white font-bold text-lg">Dashboard Financeiro</h2>
                <div class="flex items-center bg-gray-800 rounded-lg p-1 border border-gray-700">
                    <button id="prev-month" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition">‚óÄ</button>
                    <span id="current-month" class="mx-4 font-bold text-sm text-white capitalize min-w-[120px] text-center"></span>
                    <button id="next-month" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition">‚ñ∂</button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 scroll-hidden">
                
                <div id="kpi-container" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    </div>

                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 items-start">
                    
                    <div class="xl:col-span-1 space-y-6">
                        
                        <div class="card p-6 border-l-4 border-blue-500">
                            <div class="flex justify-between items-center mb-5">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Entradas / Sal√°rios</h3>
                                <span id="saved-badge" class="text-[10px] bg-green-500/20 text-green-400 px-2 py-1 rounded border border-green-500/20 font-bold opacity-0 transition-opacity">SALVO ‚úì</span>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-300 mb-1.5 ml-1">Renda Gabi</label>
                                    <div class="input-group">
                                        <span class="input-prefix">R$</span>
                                        <input type="number" id="income1" class="input-modern input-with-prefix" placeholder="0,00" step="0.01">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-300 mb-1.5 ml-1">Renda Danilo</label>
                                    <div class="input-group">
                                        <span class="input-prefix">R$</span>
                                        <input type="number" id="income2" class="input-modern input-with-prefix" placeholder="0,00" step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6 border-l-4 border-indigo-500 bg-gradient-to-br from-gray-900 to-[#1e1b4b]">
                            <div class="flex justify-between items-end mb-3">
                                <div>
                                    <h3 class="text-xs font-bold text-white uppercase tracking-widest">Meta de Reserva</h3>
                                    <p class="text-[10px] text-gray-400 mt-1">Objetivo: R$ 1.000,00</p>
                                </div>
                                <span id="res-pct" class="text-2xl font-bold text-indigo-400">0%</span>
                            </div>
                            <div class="w-full bg-gray-900 rounded-full h-2.5 mb-2 overflow-hidden border border-gray-700">
                                <div id="res-bar" class="h-full bg-indigo-500 bar-stripes transition-all duration-700" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs font-semibold mt-2">
                                <span class="text-gray-400">Atual: <span id="res-curr" class="text-white">R$ 0,00</span></span>
                                <span class="text-gray-400">Falta: <span id="res-miss" class="text-red-400">R$ 1.000,00</span></span>
                            </div>
                        </div>

                        <div class="card p-6">
                            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 text-center">Distribui√ß√£o</h3>
                            <div class="relative h-60 w-full"><canvas id="mainChart"></canvas></div>
                        </div>

                    </div>

                    <div class="xl:col-span-2 card flex flex-col h-[800px]">
                        <div class="p-5 border-b border-gray-800 flex flex-col sm:flex-row justify-between items-center gap-4 bg-[#111827]">
                            <h3 class="text-white font-bold text-lg flex items-center gap-2">Extrato</h3>
                            <div class="flex items-center gap-2 w-full sm:w-auto">
                                <input type="text" id="search" placeholder="Buscar..." class="input-modern py-2 text-sm w-full sm:w-60 bg-[#0b0f19] border-gray-700">
                                <button onclick="openModal(null, true)" class="btn-secondary whitespace-nowrap px-3 text-blue-400 border-blue-500/20 hover:bg-blue-500/10">Importar PDF</button>
                                <button onclick="openModal()" class="btn-primary whitespace-nowrap px-4">+ Novo</button>
                            </div>
                        </div>
                        
                        <div id="list" class="flex-1 overflow-y-auto p-2 space-y-1 bg-[#0b0f19]/50 scroll-hidden">
                            </div>

                        <div class="p-3 border-t border-gray-800 bg-[#111827] flex justify-between items-center text-xs">
                             <label for="import-json" class="text-gray-500 hover:text-white cursor-pointer transition">üì§ Restaurar Backup</label>
                             <input type="file" id="import-json" class="hidden">
                             <button id="export-btn" class="text-blue-400 hover:text-white font-bold">üì• BAIXAR JSON</button>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden p-4">
        <div class="card w-full max-w-md shadow-2xl border border-gray-700 animate-[fadeIn_0.2s_ease-out]">
            <div class="p-5 border-b border-gray-800 bg-[#1f2937] flex justify-between items-center rounded-t-lg">
                <h3 class="text-white font-bold" id="modal-title">Novo Lan√ßamento</h3>
                <button onclick="closeModal('modal')" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <form id="form" class="p-6 space-y-4 bg-[#111827]">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-400 mb-1">Data</label><input type="date" id="f-date" class="input-modern"></div>
                    <div><label class="block text-xs font-bold text-gray-400 mb-1">Categoria</label><select id="f-cat" class="input-modern bg-[#1f2937] cursor-pointer"></select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-400 mb-1">Descri√ß√£o</label><input type="text" id="f-desc" class="input-modern" placeholder="Ex: Mercado"></div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">Valor</label>
                    <div class="input-group">
                        <span class="input-prefix text-green-500">R$</span>
                        <input type="number" step="0.01" id="f-val" class="input-modern input-with-prefix text-green-400 text-lg" placeholder="0,00">
                    </div>
                </div>
                
                <div class="p-3 bg-[#0b0f19] rounded border border-gray-700 border-dashed hover:border-blue-500/50 transition">
                    <label class="block text-xs text-gray-400 mb-2 flex justify-between">
                        <span>Anexo / PDF (Inter/Santander)</span>
                    </label>
                    <p id="pdf-msg" class="text-xs text-green-400 font-bold hidden mb-2 bg-green-900/20 p-1 rounded text-center">‚úì PDF Lido!</p>
                    <input type="file" id="f-file" class="block w-full text-xs text-gray-400 file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:bg-gray-700 file:text-white hover:file:bg-gray-600 transition cursor-pointer" accept="application/pdf, image/*">
                    <input type="hidden" id="f-att"><input type="hidden" id="f-det">
                </div>

                <div class="flex justify-between pt-4 mt-2">
                    <button type="button" id="del-btn" onclick="delItem()" class="text-red-500 text-sm font-bold hover:text-red-400 hidden uppercase">Excluir</button>
                    <div class="flex gap-3 ml-auto">
                        <button type="button" onclick="closeModal('modal')" class="btn-secondary">Cancelar</button>
                        <button type="submit" class="btn-primary px-6">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm hidden p-4">
        <div class="card w-full max-w-3xl flex flex-col max-h-[90vh] border border-gray-700">
            <div class="p-5 border-b border-gray-800 bg-[#1f2937] flex justify-between items-center">
                <h3 class="text-white font-bold">Detalhes da Fatura</h3>
                <button onclick="closeModal('detail-modal')" class="text-gray-400 hover:text-white text-xl">&times;</button>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-5 gap-6 overflow-hidden flex-1 bg-[#111827]">
                <div class="md:col-span-2 flex flex-col items-center justify-center bg-[#0b0f19] p-4 rounded-lg border border-gray-800">
                    <div class="relative h-48 w-full"><canvas id="detailChart"></canvas></div>
                </div>
                <div class="md:col-span-3 flex flex-col h-full overflow-hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-bold text-white">Itens</h4>
                        <a id="dl-link" href="#" class="text-xs text-blue-400 hover:text-white font-bold underline">BAIXAR PDF</a>
                    </div>
                    <div id="det-list" class="flex-1 overflow-y-auto pr-2 space-y-2 scroll-hidden"></div>
                    <button onclick="delItem()" class="mt-4 w-full border border-red-500/30 text-red-400 hover:bg-red-500/10 py-2 rounded font-bold uppercase text-xs">Apagar Registro</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
        
        const firebaseConfig = { apiKey: "AIzaSyBf1nzx6mH1lWckWQyXDnWZKLlh-5cfcv0", authDomain: "controle-a9909.firebaseapp.com", projectId: "controle-a9909", storageBucket: "controle-a9909.appspot.com", messagingSenderId: "43886457318", appId: "1:43886457318:web:289e82579a38c28fefa627" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const USER_ID = 'casal_principal';
        const ACCOUNTS = { 'gabi': '19071996', 'danilo': '08042020', 'casal': '123456' }; // Adicionei 'casal' para teste facil
        const CATS = ['Mercado', 'Contas', 'Cart√µes', 'Apartamento', 'Carro', 'Lazer', 'Delivery', 'Posto', 'Farm√°cia', 'Roupa', 'Escola', 'Poupan√ßa Maria Luisa', 'Reserva', 'Outros'];
        const COLORS = { 'Mercado': '#fbbf24', 'Contas': '#34d399', 'Cart√µes': '#38bdf8', 'Apartamento': '#a78bfa', 'Carro': '#60a5fa', 'Lazer': '#f87171', 'Delivery': '#e879f9', 'Posto': '#fb923c', 'Farm√°cia': '#a3e635', 'Roupa': '#f472b6', 'Escola': '#818cf8', 'Poupan√ßa Maria Luisa': '#22d3ee', 'Reserva': '#4ade80', 'Outros': '#9ca3af' };
        
        let dataList = [], income = {}, curDate = new Date(), editId = null, mChart = null, dChart = null;

        // Init
        document.getElementById('f-cat').innerHTML = CATS.map(c => `<option value="${c}">${c}</option>`).join('');
        
        // Login
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value.trim();
            if(ACCOUNTS[u] && ACCOUNTS[u] === p) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                setTimeout(() => document.getElementById('app').classList.remove('opacity-0'), 100);
                document.getElementById('user-name').innerText = u;
                document.getElementById('avatar-initial').innerText = u[0].toUpperCase();
                load();
            } else { document.getElementById('login-msg').classList.remove('hidden'); }
        };

        document.getElementById('logout-btn').onclick = () => location.reload();

        async function load() {
            document.getElementById('loader').style.display = 'flex';
            const snap = await db.collection('users').doc(USER_ID).collection('expenses').get();
            dataList = snap.docs.map(d => ({id: d.id, ...d.data()}));
            const incSnap = await db.collection('users').doc(USER_ID).collection('income').get();
            income = {}; incSnap.forEach(d => income[d.id] = d.data());
            render();
            document.getElementById('loader').style.display = 'none';
        }

        function render(search = '') {
            const mKey = curDate.toISOString().slice(0, 7);
            document.getElementById('current-month').innerText = curDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});
            
            let filtered = dataList.filter(d => d.date.startsWith(mKey)).sort((a,b) => new Date(b.date) - new Date(a.date));
            if(search) filtered = filtered.filter(d => d.description.toLowerCase().includes(search.toLowerCase()) || d.category.toLowerCase().includes(search.toLowerCase()));

            // Income & Totals
            const inc = income[mKey] || {s1:'', s2:''};
            document.getElementById('income1').value = inc.s1;
            document.getElementById('income2').value = inc.s2;

            const allM = dataList.filter(d => d.date.startsWith(mKey));
            const totExp = allM.reduce((a,b) => a + b.value, 0);
            const totInc = (parseFloat(inc.s1)||0) + (parseFloat(inc.s2)||0);
            const bal = totInc - totExp;

            // RESERVA (1000)
            const resVal = allM.filter(d => d.category === 'Reserva').reduce((a,b) => a + b.value, 0);
            const resPct = Math.min((resVal/1000)*100, 100);
            document.getElementById('res-val').innerText = fmt(resVal);
            document.getElementById('res-miss').innerText = fmt(Math.max(1000-resVal, 0));
            document.getElementById('res-pct').innerText = Math.floor(resPct) + '%';
            document.getElementById('res-bar').style.width = resPct + '%';
            document.getElementById('res-bar').className = resVal >= 1000 ? 'h-full bg-yellow-400 bar-stripes' : 'h-full bg-indigo-500 bar-stripes';
            document.getElementById('res-pct').className = resVal >= 1000 ? 'text-2xl font-bold text-yellow-400' : 'text-2xl font-bold text-indigo-400';

            // KPI
            document.getElementById('kpi-container').innerHTML = `
                <div class="card p-5 border-t-4 border-green-500 bg-[#111827] flex items-center">
                    <div class="w-12 h-12 rounded-full bg-green-500/10 flex items-center justify-center text-2xl mr-4">üí∞</div>
                    <div><p class="text-xs text-gray-400 font-bold uppercase">Receita</p><p class="text-2xl font-bold text-white">${fmt(totInc)}</p></div>
                </div>
                <div class="card p-5 border-t-4 border-red-500 bg-[#111827] flex items-center">
                    <div class="w-12 h-12 rounded-full bg-red-500/10 flex items-center justify-center text-2xl mr-4">üí∏</div>
                    <div><p class="text-xs text-gray-400 font-bold uppercase">Despesas</p><p class="text-2xl font-bold text-white">${fmt(totExp)}</p></div>
                </div>
                <div class="card p-5 border-t-4 ${bal>=0?'border-blue-500':'border-yellow-500'} bg-[#111827] flex items-center">
                    <div class="w-12 h-12 rounded-full bg-gray-800 flex items-center justify-center text-2xl mr-4">‚öñÔ∏è</div>
                    <div><p class="text-xs text-gray-400 font-bold uppercase">Saldo</p><p class="text-2xl font-bold ${bal>=0?'text-blue-400':'text-yellow-400'}">${fmt(bal)}</p></div>
                </div>
            `;

            // Lista
            const listEl = document.getElementById('list');
            listEl.innerHTML = '';
            if(!filtered.length) listEl.innerHTML = '<div class="text-center text-gray-600 py-10 font-medium">Sem lan√ßamentos</div>';
            else {
                filtered.forEach(d => {
                    const c = COLORS[d.category] || '#999';
                    const hasDet = d.details && Object.keys(d.details).length > 0;
                    const act = hasDet ? `onclick="openDet('${d.id}')"` : `onclick="openModal('${d.id}')"`;
                    const icon = hasDet ? 'üí≥' : '$';
                    
                    listEl.innerHTML += `
                        <div ${act} class="group flex items-center px-4 py-3 bg-[#111827] hover:bg-gray-800 rounded-lg border border-gray-800 hover:border-blue-900 cursor-pointer transition mb-1">
                            <div class="w-10 h-10 rounded bg-[#0b0f19] border border-gray-700 flex items-center justify-center text-lg mr-3 shadow-sm" style="color:${c}">${icon}</div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-bold text-white truncate">${d.description}</p>
                                <div class="flex items-center gap-2 mt-0.5">
                                    <span class="text-[10px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 border border-gray-700 text-gray-400">${d.category}</span>
                                    ${hasDet ? '<span class="text-[10px] bg-blue-900/30 text-blue-400 px-1 rounded border border-blue-900">FATURA</span>' : ''}
                                    <span class="text-xs text-gray-600">${new Date(d.date).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})}</span>
                                </div>
                            </div>
                            <div class="text-right font-bold text-white mr-3">${fmt(d.value)}</div>
                            <button onclick="directDel('${d.id}', event)" class="text-gray-600 hover:text-red-500 opacity-0 group-hover:opacity-100 transition p-2">‚úï</button>
                        </div>
                    `;
                });
            }
            drawChart(allM, 'mainChart');
        }

        // CRUD
        document.getElementById('form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.innerText = "..."; btn.disabled = true;
            try {
                const fileIn = document.getElementById('f-file');
                let att = document.getElementById('f-att').value;
                let det = document.getElementById('f-det').value ? JSON.parse(document.getElementById('f-det').value) : null;
                
                if(fileIn.files[0]) att = await toBase64(fileIn.files[0]);
                
                const pl = {
                    date: document.getElementById('f-date').value,
                    category: document.getElementById('f-cat').value,
                    description: document.getElementById('f-desc').value,
                    value: parseFloat(document.getElementById('f-val').value),
                    attachment: att, details: det
                };

                if(editId) await db.collection('users').doc(USER_ID).collection('expenses').doc(editId).update(pl);
                else await db.collection('users').doc(USER_ID).collection('expenses').add(pl);
                
                closeModal('modal'); load();
            } catch(er) { alert(er); }
            btn.innerText = "Salvar"; btn.disabled = false;
        };

        // PDF Logic (Simplificado para Inter/Santander/Nubank)
        document.getElementById('f-file').onchange = async (e) => {
            const f = e.target.files[0];
            if(!f || f.type !== 'application/pdf') return;
            document.getElementById('pdf-msg').innerText = "Processando..."; document.getElementById('pdf-msg').classList.remove('hidden');
            try {
                const buff = await f.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buff).promise;
                let txt = "", tot = 0, bk = {};
                for(let i=1; i<=pdf.numPages; i++) txt += (await (await pdf.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ') + " ";
                
                // Regex Generico para pegar data/desc/valor
                const rx = /(\d{2}\/\d{2})\s+(.*?)\s+(-?[\d\.]*?[\d]+,\d{2})/g;
                let m;
                const IGNORE = ['PAGAMENTO', 'SALDO', 'TOTAL', 'PARCELA', 'CREDITO'];
                
                while((m = rx.exec(txt)) !== null) {
                    const d = m[2].trim().toUpperCase();
                    const v = parseFloat(m[3].replace('.','').replace(',','.'));
                    if(IGNORE.some(x => d.includes(x)) || v <= 0) continue;
                    
                    let cat = 'Outros';
                    // Keywords simples
                    if(d.includes('UBER') || d.includes('POSTO')) cat = 'Carro';
                    else if(d.includes('IFOOD') || d.includes('MC') || d.includes('BK')) cat = 'Delivery';
                    else if(d.includes('MERCADO') || d.includes('ATACAD')) cat = 'Mercado';
                    else if(d.includes('FARM')) cat = 'Farm√°cia';
                    
                    if(!bk[cat]) bk[cat] = [];
                    bk[cat].push({desc: d, val: v});
                    tot += v;
                }
                
                if(tot > 0) {
                    document.getElementById('f-val').value = tot.toFixed(2);
                    document.getElementById('f-desc').value = "Fatura Cart√£o";
                    document.getElementById('f-cat').value = "Cart√µes";
                    document.getElementById('f-det').value = JSON.stringify(bk);
                    document.getElementById('pdf-msg').innerText = "‚úì Sucesso! R$ " + tot.toFixed(2);
                } else { document.getElementById('pdf-msg').innerText = "‚ö† Nada encontrado"; }
            } catch(e) { console.log(e); document.getElementById('pdf-msg').innerText = "Erro no PDF"; }
        };

        // Helpers
        function openModal(id=null, isImp=false) {
            editId = id;
            document.getElementById('form').reset();
            document.getElementById('f-att').value = '';
            document.getElementById('f-det').value = '';
            document.getElementById('pdf-msg').classList.add('hidden');
            document.getElementById('del-btn').classList.add('hidden');
            
            if(id) {
                const d = dataList.find(x => x.id === id);
                document.getElementById('f-date').value = d.date;
                document.getElementById('f-cat').value = d.category;
                document.getElementById('f-desc').value = d.description;
                document.getElementById('f-val').value = d.value;
                document.getElementById('f-att').value = d.attachment||'';
                document.getElementById('del-btn').classList.remove('hidden');
            } else {
                document.getElementById('f-date').value = new Date().toISOString().split('T')[0];
                if(isImp) document.getElementById('f-file').click();
            }
            document.getElementById('modal').classList.remove('hidden');
        }

        function openDet(id) {
            editId = id;
            const d = dataList.find(x => x.id === id);
            const el = document.getElementById('det-list');
            el.innerHTML = '';
            
            if(d.attachment) { document.getElementById('dl-link').href = d.attachment; document.getElementById('dl-link').style.display='block'; }
            else document.getElementById('dl-link').style.display='none';

            let lbs=[], dat=[], cls=[];
            Object.keys(d.details).forEach(k => {
                const sum = d.details[k].reduce((a,b)=>a+b.val,0);
                lbs.push(k); dat.push(sum); cls.push(COLORS[k]||'#666');
                el.innerHTML += `<div class="mb-2 border border-gray-700 rounded"><div class="px-3 py-1 bg-gray-800 text-xs font-bold text-white flex justify-between"><span>${k}</span><span>${fmt(sum)}</span></div><div class="px-3 py-1 bg-gray-900/50">` +
                d.details[k].map(x => `<div class="flex justify-between text-[10px] text-gray-400 py-1 border-b border-gray-800 last:border-0"><span class="truncate pr-2">${x.desc}</span><span>${fmt(x.val)}</span></div>`).join('') + `</div></div>`;
            });
            
            if(dChart) dChart.destroy();
            dChart = new Chart(document.getElementById('detailChart'), {type:'doughnut', data:{labels:lbs, datasets:[{data:dat, backgroundColor:cls, borderWidth:0}]}, options:{plugins:{legend:{display:false}}, cutout:'60%'}});
            document.getElementById('detail-modal').classList.remove('hidden');
        }

        async function delItem() { if(confirm("Confirmar exclus√£o?")) { await db.collection('users').doc(USER_ID).collection('expenses').doc(editId).delete(); location.reload(); } }
        async function directDel(id, e) { e.stopPropagation(); editId=id; delItem(); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function fmt(v) { return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
        const toBase64 = f => new Promise((r,j)=>{const rd=new FileReader(); rd.readAsDataURL(f); rd.onload=()=>r(rd.result); rd.onerror=j;});

        async function saveInc() {
            const mk = curDate.toISOString().slice(0, 7);
            const s1 = document.getElementById('income1').value;
            const s2 = document.getElementById('income2').value;
            income[mk] = {s1, s2};
            document.getElementById('saved-badge').classList.remove('opacity-0');
            setTimeout(()=>document.getElementById('saved-badge').classList.add('opacity-0'), 2000);
            render();
            await db.collection('users').doc(USER_ID).collection('income').doc(mk).set({s1, s2}, {merge:true});
        }
        document.getElementById('income1').onchange = saveInc;
        document.getElementById('income2').onchange = saveInc;
        document.getElementById('search').oninput = (e) => render(e.target.value);
        document.getElementById('prev-month').onclick = () => { curDate.setMonth(curDate.getMonth()-1); load(); };
        document.getElementById('next-month').onclick = () => { curDate.setMonth(curDate.getMonth()+1); load(); };

        function drawChart(data, cvs) {
            if(mChart) mChart.destroy();
            const grp = {}; data.forEach(d => grp[d.category] = (grp[d.category]||0)+d.value);
            mChart = new Chart(document.getElementById(cvs), {
                type: 'doughnut',
                data: { labels: Object.keys(grp), datasets: [{ data: Object.values(grp), backgroundColor: Object.keys(grp).map(k=>COLORS[k]||'#666'), borderWidth:0 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'right', labels:{color:'#9ca3af', font:{size:10}, boxWidth:8, usePointStyle:true}}} }
            });
        }

        // Backup
        document.getElementById('export-btn').onclick = () => {
            const b = new Blob([JSON.stringify({expenses:dataList, income})], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='backup.json'; a.click();
        }
        document.getElementById('import-json').onchange = (e) => {
            const r = new FileReader(); r.onload=ev=>{
                const d = JSON.parse(ev.target.result);
                if(confirm("Importar?")) { dataList=d.expenses||[]; income=d.income||{}; render(); }
            }; r.readAsText(e.target.files[0]);
        }
    </script>
</body>
</html>
