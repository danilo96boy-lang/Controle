<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro - Casal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg: #111827; --card: #1f2937; --primary: #6366f1; --text: #f9fafb; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; }
        
        /* Loading */
        #loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .expense-item { transition: all 0.2s; }
        .expense-item:hover { transform: translateX(4px); background-color: #374151; cursor: pointer; }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 md:p-8">

    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-xl w-full max-w-sm border border-gray-700 shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-center">Acesso Financeiro</h2>
            <form id="login-form" class="space-y-4">
                <input type="text" id="user" placeholder="Usu√°rio" class="w-full p-3 bg-gray-900 border border-gray-600 rounded text-white focus:border-indigo-500 outline-none">
                <input type="password" id="pass" placeholder="Senha" class="w-full p-3 bg-gray-900 border border-gray-600 rounded text-white focus:border-indigo-500 outline-none">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 py-3 rounded font-bold transition">Entrar</button>
            </form>
            <p id="login-msg" class="text-red-400 text-center mt-4 hidden text-sm">Dados incorretos.</p>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p class="text-white font-medium">Carregando...</p>
    </div>

    <div id="app-container" class="max-w-6xl mx-auto w-full opacity-0 transition-opacity duration-700 hidden">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Painel Financeiro</h1>
                <p class="text-gray-400">Ol√°, <span id="user-display" class="text-indigo-400 font-bold capitalize"></span></p>
            </div>
            <div class="flex items-center bg-gray-800 rounded-full px-4 py-2 border border-gray-700 shadow-lg">
                <button id="prev-month" class="p-2 hover:text-indigo-400">‚óÄ</button>
                <span id="current-month" class="mx-4 font-bold min-w-[140px] text-center capitalize text-lg"></span>
                <button id="next-month" class="p-2 hover:text-indigo-400">‚ñ∂</button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="space-y-6">
                <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg">
                    <h3 class="text-xs font-bold text-gray-400 uppercase mb-3">Renda Mensal</h3>
                    <div class="space-y-3">
                        <input type="number" id="income1" placeholder="Renda Gabi" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white">
                        <input type="number" id="income2" placeholder="Renda Danilo" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm text-white">
                    </div>
                </div>

                <div id="summary-display" class="space-y-3"></div>

                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                    <h4 class="text-center font-bold text-gray-400 mb-3 text-xs uppercase">Gastos por Categoria</h4>
                    <div class="relative h-48"><canvas id="expenseChart"></canvas></div>
                </div>
            </div>

            <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700 h-[700px] flex flex-col shadow-lg">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                    <h3 class="font-bold text-xl">Lan√ßamentos</h3>
                    <button onclick="openModal()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-sm font-bold shadow transition flex items-center gap-2">
                        <span>+ Adicionar Lan√ßamento</span>
                    </button>
                </div>
                
                <div id="expense-list" class="flex-1 overflow-y-auto pr-2 space-y-2">
                    </div>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 bg-black/80 hidden z-50 items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md border border-gray-600 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="modal-title">Novo Lan√ßamento</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            
            <form id="expense-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Data</label>
                        <input type="date" id="form-date" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none" required>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 block mb-1">Categoria</label>
                        <select id="form-cat" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none"></select>
                    </div>
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 block mb-1">Descri√ß√£o</label>
                    <input type="text" id="form-desc" placeholder="Ex: Mercado Semanal" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none" required>
                </div>
                
                <div>
                    <label class="text-xs text-gray-400 block mb-1">Valor (R$)</label>
                    <input type="number" step="0.01" id="form-val" placeholder="0,00" class="w-full bg-gray-900 border border-gray-600 rounded p-2 focus:border-indigo-500 outline-none" required>
                </div>

                <div class="pt-2 border-t border-gray-700">
                    <label class="text-xs text-gray-400 block mb-2">Anexar Comprovante (Opcional - Imagem/PDF)</label>
                    <input type="file" id="form-file" class="block w-full text-xs text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-gray-700 file:text-white hover:file:bg-gray-600">
                    <input type="hidden" id="existing-file">
                </div>
                
                <div class="flex justify-between pt-4 mt-2">
                    <button type="button" id="delete-btn" onclick="deleteItem()" class="text-red-500 font-bold hover:text-red-400 hidden">Excluir</button>
                    <div class="flex gap-2 ml-auto">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 rounded font-bold hover:bg-indigo-500 transition">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBf1nzx6mH1lWckWQyXDnWZKLlh-5cfcv0",
            authDomain: "controle-a9909.firebaseapp.com",
            projectId: "controle-a9909",
            storageBucket: "controle-a9909.appspot.com",
            messagingSenderId: "43886457318",
            appId: "1:43886457318:web:289e82579a38c28fefa627"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const userId = 'casal_principal';

        const USERS = { 'gabi': '19071996', 'danilo': '08042020' };
        const CATEGORIES = ['Mercado', 'Contas', 'Apartamento', 'Carro', 'Lazer', 'Delivery', 'Posto', 'Farm√°cia', 'Roupa', 'Escola', 'Poupan√ßa Maria Luisa', 'Reserva', 'Uber/Transporte', 'Assinaturas', 'Outros'];
        const CAT_COLORS = { 'Mercado': '#f59e0b', 'Contas': '#10b981', 'Apartamento': '#a855f7', 'Carro': '#3b82f6', 'Lazer': '#ef4444', 'Delivery': '#d946ef', 'Posto': '#ea580c', 'Farm√°cia': '#84cc16', 'Outros': '#6b7280' };

        let expenses = [];
        let incomeData = {};
        let currentDate = new Date();
        let currentEditId = null;
        let chartInstance = null;

        // INIT
        function init() {
            const sel = document.getElementById('form-cat');
            sel.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            loadData();
        }

        // LOGIN logic
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value.trim();
            if(USERS[u] && USERS[u] === p) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                setTimeout(() => document.getElementById('app-container').classList.remove('opacity-0'), 50);
                document.getElementById('user-display').innerText = u;
                init();
            } else {
                document.getElementById('login-msg').classList.remove('hidden');
            }
        };

        // LOAD DATA
        async function loadData() {
            toggleLoader(true);
            try {
                // Carrega gastos
                const snap = await db.collection('users').doc(userId).collection('expenses').get();
                expenses = snap.docs.map(d => ({id: d.id, ...d.data()}));
                // Carrega renda
                const incSnap = await db.collection('users').doc(userId).collection('income').get();
                incomeData = {};
                incSnap.forEach(d => incomeData[d.id] = d.data());
                render();
            } catch(e) { console.error(e); alert("Erro ao carregar dados."); }
            toggleLoader(false);
        }

        // RENDER UI
        function render() {
            const monthKey = currentDate.toISOString().slice(0, 7);
            document.getElementById('current-month').innerText = currentDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});

            const curExpenses = expenses
                .filter(e => e.date.startsWith(monthKey))
                .sort((a,b) => new Date(b.date) - new Date(a.date));

            // Renda
            const inc = incomeData[monthKey] || {s1:'', s2:''};
            document.getElementById('income1').value = inc.s1;
            document.getElementById('income2').value = inc.s2;

            // C√°lculos
            const totalExp = curExpenses.reduce((a,b) => a + b.value, 0);
            const totalInc = (parseFloat(inc.s1)||0) + (parseFloat(inc.s2)||0);
            const balance = totalInc - totalExp;

            document.getElementById('summary-display').innerHTML = `
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center"><span>Renda Total</span><span class="font-bold text-green-400">${fmtMoney(totalInc)}</span></div>
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between items-center"><span>Total Sa√≠das</span><span class="font-bold text-red-400">${fmtMoney(totalExp)}</span></div>
                <div class="bg-indigo-900/40 p-4 rounded border border-indigo-500/30 flex justify-between items-center text-lg mt-2"><span>Saldo</span><span class="font-bold ${balance>=0?'text-green-300':'text-red-300'}">${fmtMoney(balance)}</span></div>
            `;

            // Lista
            const listEl = document.getElementById('expense-list');
            listEl.innerHTML = '';
            
            if(curExpenses.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-500 py-10">Nenhum lan√ßamento neste m√™s.</div>';
            } else {
                curExpenses.forEach(item => {
                    const day = item.date.split('-')[2];
                    const color = CAT_COLORS[item.category] || '#6b7280';
                    // √çcone de clipe se tiver anexo
                    const attachIcon = item.attachment ? `<span class="text-xs text-indigo-400 ml-2" title="Comprovante Anexado">üìé</span>` : '';
                    const downloadLink = item.attachment ? `<a href="${item.attachment}" download="comprovante.pdf" class="text-xs hover:text-white text-gray-400 underline mr-3" onclick="event.stopPropagation()">Baixar</a>` : '';

                    listEl.innerHTML += `
                        <div onclick="openModal('${item.id}')" class="expense-item bg-gray-700/50 p-3 rounded-lg flex items-center justify-between border-l-4 mb-2" style="border-color: ${color}">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="bg-gray-800 w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold text-gray-400 shrink-0">${day}</div>
                                <div class="min-w-0">
                                    <p class="font-bold text-sm text-white truncate">${item.description} ${attachIcon}</p>
                                    <p class="text-xs text-gray-400">${item.category}</p>
                                </div>
                            </div>
                            <div class="flex items-center">
                                ${downloadLink}
                                <span class="font-bold text-white whitespace-nowrap">${fmtMoney(item.value)}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            updateChart(curExpenses);
        }

        // --- MANIPULA√á√ÉO DO MODAL ---

        function openModal(id = null) {
            currentEditId = id;
            document.getElementById('delete-btn').classList.add('hidden');
            
            if(id) {
                // Modo Edi√ß√£o
                document.getElementById('modal-title').innerText = "Editar Lan√ßamento";
                document.getElementById('delete-btn').classList.remove('hidden');
                const item = expenses.find(e => e.id === id);
                document.getElementById('form-date').value = item.date;
                document.getElementById('form-desc').value = item.description;
                document.getElementById('form-cat').value = item.category;
                document.getElementById('form-val').value = item.value;
                document.getElementById('existing-file').value = item.attachment || '';
            } else {
                // Modo Novo
                document.getElementById('modal-title').innerText = "Novo Lan√ßamento";
                document.getElementById('expense-form').reset();
                document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('existing-file').value = '';
            }
            
            document.getElementById('expense-modal').classList.remove('hidden');
            document.getElementById('expense-modal').classList.add('flex');
        }

        document.getElementById('expense-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Salvando...";
            btn.disabled = true;

            try {
                // Upload Arquivo (Base64 simples)
                const fileInput = document.getElementById('form-file');
                let attachment = document.getElementById('existing-file').value;
                
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    if (file.size > 800 * 1024) { // Limite 800kb
                        alert("Arquivo muito grande! M√°ximo 800kb.");
                        throw new Error("File too big");
                    }
                    attachment = await convertBase64(file);
                }

                const data = {
                    date: document.getElementById('form-date').value,
                    description: document.getElementById('form-desc').value,
                    category: document.getElementById('form-cat').value,
                    value: parseFloat(document.getElementById('form-val').value),
                    attachment: attachment
                };

                if(currentEditId) {
                    await db.collection('users').doc(userId).collection('expenses').doc(currentEditId).update(data);
                } else {
                    await db.collection('users').doc(userId).collection('expenses').add(data);
                }
                
                closeModal();
                loadData();
            } catch(err) {
                console.error(err);
                if(err.message !== "File too big") alert("Erro ao salvar.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        async function deleteItem() {
            if(confirm("Tem certeza que deseja excluir?")) {
                await db.collection('users').doc(userId).collection('expenses').doc(currentEditId).delete();
                closeModal();
                loadData();
            }
        }

        // UTILIT√ÅRIOS
        const convertBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        async function saveIncome() {
            const mk = currentDate.toISOString().slice(0, 7);
            await db.collection('users').doc(userId).collection('income').doc(mk).set({
                s1: document.getElementById('income1').value, s2: document.getElementById('income2').value
            }, {merge:true});
            render(); // Atualiza saldo na hora
        }
        document.getElementById('income1').onchange = saveIncome;
        document.getElementById('income2').onchange = saveIncome;

        function updateChart(data) {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            const cats = {};
            data.forEach(d => cats[d.category] = (cats[d.category]||0) + d.value);
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{ data: Object.values(cats), backgroundColor: Object.keys(cats).map(k=>CAT_COLORS[k]||'#666'), borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff', font: {size: 10} } } } }
            });
        }

        function toggleLoader(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; }
        function closeModal() { document.getElementById('expense-modal').classList.add('hidden'); document.getElementById('expense-modal').classList.remove('flex'); }
        function fmtMoney(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }

        document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); loadData(); };
        document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); loadData(); };
    </script>
</body>
</html>
