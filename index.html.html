<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <style>
        :root {
            --bg-color: #111827;
            --card-bg: #1f2937;
            --primary: #6366f1;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
        }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Poppins', sans-serif; }
        .font-display { font-family: 'Inter', sans-serif; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 50;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tabs */
        .tab-btn { border-bottom: 2px solid transparent; opacity: 0.6; transition: all 0.3s; }
        .tab-btn.active { border-color: var(--primary); opacity: 1; color: var(--primary); }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .expense-card { transition: transform 0.2s; }
        .expense-card:hover { transform: scale(1.01); background-color: #2d3748; cursor: pointer; }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 sm:p-6 lg:p-8">

    <div id="login-screen" class="fixed inset-0 bg-gray-900 z-50 flex items-center justify-center transition-opacity duration-500">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-gray-700">
            <h2 class="text-2xl font-bold mb-4">Acesso Seguro</h2>
            <form id="login-form" class="space-y-4">
                <input type="text" id="user" placeholder="Usu√°rio" class="w-full p-3 rounded bg-gray-900 border border-gray-700 text-white focus:outline-none focus:border-indigo-500">
                <input type="password" id="pass" placeholder="Senha" class="w-full p-3 rounded bg-gray-900 border border-gray-700 text-white focus:outline-none focus:border-indigo-500">
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded transition">Entrar</button>
            </form>
            <p id="login-msg" class="text-red-400 text-sm mt-3 hidden">Dados incorretos.</p>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <p id="loading-text" class="text-white font-medium">Processando...</p>
    </div>

    <div id="app-container" class="max-w-6xl mx-auto w-full flex flex-col gap-6 opacity-0 transition-opacity duration-500">
        
        <header class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold font-display">Painel Financeiro</h1>
                <p class="text-gray-400 text-sm">Ol√°, <span id="user-name" class="text-indigo-400 font-bold"></span>.</p>
            </div>
            
            <div class="flex items-center bg-gray-800 rounded-full p-1 px-4 shadow-lg border border-gray-700">
                <button id="prev-month" class="p-2 hover:text-indigo-400">‚óÄ</button>
                <span id="current-month" class="mx-4 font-bold min-w-[120px] text-center capitalize"></span>
                <button id="next-month" class="p-2 hover:text-indigo-400">‚ñ∂</button>
            </div>
        </header>

        <div class="flex gap-6 border-b border-gray-700">
            <button class="tab-btn active pb-3 font-medium text-lg" onclick="switchTab('geral')">Vis√£o Geral (Manual)</button>
            <button class="tab-btn pb-3 font-medium text-lg" onclick="switchTab('cartao')">Fatura do Cart√£o</button>
        </div>

        <div id="tab-geral" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-4">
                    <div class="bg-gray-800 p-5 rounded-xl border border-gray-700 shadow-lg">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Renda Mensal</h3>
                        <div class="space-y-2">
                            <input type="number" id="income1" placeholder="Renda Gabi" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm">
                            <input type="number" id="income2" placeholder="Renda Danilo" class="w-full bg-gray-900 border border-gray-700 rounded p-2 text-sm">
                        </div>
                    </div>

                    <div id="financial-summary" class="space-y-3">
                        </div>
                </div>

                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700 h-[600px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-xl">Gastos Manuais (Pix/D√©bito)</h3>
                        <button onclick="addManualExpense()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-sm font-bold shadow">+ Novo</button>
                    </div>
                    <div id="manual-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
                        </div>
                </div>
            </div>
        </div>

        <div id="tab-cartao" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-4">
                    <div class="bg-gray-800 p-6 rounded-xl border border-dashed border-indigo-500 text-center">
                        <div class="mb-4 text-4xl">üìÑ</div>
                        <h3 class="font-bold mb-2">Importar Fatura PDF</h3>
                        <p class="text-xs text-gray-400 mb-4">Suporta Nubank, Inter e PDFs padr√£o. O sistema tentar√° classificar os gastos automaticamente.</p>
                        
                        <input type="file" id="pdf-input" class="hidden" accept="application/pdf">
                        <label for="pdf-input" class="block w-full bg-indigo-600 hover:bg-indigo-700 cursor-pointer text-white font-bold py-2 rounded transition">
                            Selecionar Arquivo
                        </label>
                    </div>

                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                        <h4 class="text-center text-sm font-bold text-gray-400 mb-2">Distribui√ß√£o da Fatura</h4>
                        <div class="h-48 relative">
                            <canvas id="cardChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-gray-800 p-6 rounded-xl border border-gray-700 h-[600px] flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="font-bold text-xl">Itens da Fatura</h3>
                            <p id="card-total-display" class="text-indigo-400 font-bold text-lg">Total: R$ 0,00</p>
                        </div>
                        <button onclick="clearCardExpenses()" class="text-red-400 hover:text-red-300 text-sm underline">Limpar Fatura do M√™s</button>
                    </div>
                    <div id="card-list" class="flex-1 overflow-y-auto space-y-2 pr-2">
                        <div class="text-center text-gray-500 mt-10">Nenhuma fatura importada ainda.</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black/70 hidden z-50 items-center justify-center p-4">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md border border-gray-600">
            <h3 class="text-xl font-bold mb-4">Editar Lan√ßamento</h3>
            <form id="edit-form" class="space-y-3">
                <input type="date" id="edit-date" class="w-full bg-gray-900 border border-gray-700 rounded p-2">
                <input type="text" id="edit-desc" placeholder="Descri√ß√£o" class="w-full bg-gray-900 border border-gray-700 rounded p-2">
                <select id="edit-cat" class="w-full bg-gray-900 border border-gray-700 rounded p-2">
                    </select>
                <input type="number" step="0.01" id="edit-val" placeholder="Valor" class="w-full bg-gray-900 border border-gray-700 rounded p-2">
                
                <div class="flex justify-between pt-4 border-t border-gray-700 mt-4">
                    <button type="button" onclick="deleteCurrentItem()" class="text-red-500 font-bold text-sm">Excluir</button>
                    <div class="space-x-2">
                        <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-700 rounded">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-indigo-600 rounded font-bold">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO PDF.JS
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBf1nzx6mH1lWckWQyXDnWZKLlh-5cfcv0",
            authDomain: "controle-a9909.firebaseapp.com",
            projectId: "controle-a9909",
            storageBucket: "controle-a9909.appspot.com",
            messagingSenderId: "43886457318",
            appId: "1:43886457318:web:289e82579a38c28fefa627"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const userId = 'casal_principal';

        // DADOS
        const USERS = { 'gabi': '19071996', 'danilo': '08042020' };
        const CATEGORIES = ['Mercado', 'Contas', 'Apartamento', 'Carro', 'Lazer', 'Delivery', 'Posto', 'Farm√°cia', 'Roupa', 'Escola', 'Poupan√ßa Maria Luisa', 'Reserva', 'Uber/Transporte', 'Assinaturas', 'Outros'];
        
        // AUTO-CATEGORIZA√á√ÉO (Palavras-chave)
        const KEYWORDS = {
            'uber': 'Uber/Transporte', '99': 'Uber/Transporte', 'sem parar': 'Carro',
            'ifood': 'Delivery', 'rappi': 'Delivery', 'ze delivery': 'Delivery', 'mc donalds': 'Lazer',
            'netflix': 'Assinaturas', 'spotify': 'Assinaturas', 'amazon': 'Assinaturas', 'apple': 'Assinaturas',
            'carrefour': 'Mercado', 'atacadao': 'Mercado', 'pao de acucar': 'Mercado', 'extra': 'Mercado',
            'drogaria': 'Farm√°cia', 'farmacia': 'Farm√°cia', 'pague menos': 'Farm√°cia',
            'posto': 'Posto', 'shell': 'Posto', 'ipiranga': 'Posto',
            'cpfl': 'Contas', 'claro': 'Contas', 'vivo': 'Contas', 'tim': 'Contas'
        };

        let expenses = [];
        let incomeData = {};
        let currentDate = new Date();
        let currentEditId = null;
        let chartInstance = null;

        // --- SISTEMA ---

        function init() {
            // Preencher select de categorias
            const select = document.getElementById('edit-cat');
            CATEGORIES.forEach(c => select.innerHTML += `<option value="${c}">${c}</option>`);

            loadData();
        }

        // Login
        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            const u = document.getElementById('user').value.toLowerCase().trim();
            const p = document.getElementById('pass').value.trim();
            if(USERS[u] && USERS[u] === p) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('opacity-0');
                document.getElementById('user-name').innerText = u.charAt(0).toUpperCase() + u.slice(1);
                init();
            } else {
                document.getElementById('login-msg').classList.remove('hidden');
            }
        };

        // Carregar Dados
        async function loadData() {
            toggleLoading(true);
            try {
                const snapshot = await db.collection('users').doc(userId).collection('expenses').get();
                expenses = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                const incSnap = await db.collection('users').doc(userId).collection('income').get();
                incomeData = {};
                incSnap.forEach(doc => incomeData[doc.id] = doc.data());
                
                render();
            } catch(e) { console.error(e); alert('Erro ao carregar dados'); }
            toggleLoading(false);
        }

        // Renderiza√ß√£o Principal
        function render() {
            const monthKey = currentDate.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('current-month').innerText = currentDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});

            // Filtros
            const monthExpenses = expenses.filter(e => e.date.startsWith(monthKey));
            const manual = monthExpenses.filter(e => e.source === 'manual');
            const card = monthExpenses.filter(e => e.source === 'invoice');

            // Render Listas
            renderList(manual, 'manual-list', false);
            renderList(card, 'card-list', true);

            // Renda
            const curIncome = incomeData[monthKey] || {s1:0, s2:0};
            document.getElementById('income1').value = curIncome.s1 || '';
            document.getElementById('income2').value = curIncome.s2 || '';

            // Totais
            const totalManual = manual.reduce((a,b)=>a+b.value,0);
            const totalCard = card.reduce((a,b)=>a+b.value,0);
            const totalIncome = (parseFloat(curIncome.s1)||0) + (parseFloat(curIncome.s2)||0);
            const balance = totalIncome - (totalManual + totalCard);

            document.getElementById('card-total-display').innerText = `Total: ${formatMoney(totalCard)}`;
            
            document.getElementById('financial-summary').innerHTML = `
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between"><span>Renda Total</span><span class="font-bold text-green-400">${formatMoney(totalIncome)}</span></div>
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between"><span>Manual</span><span class="font-bold text-red-400">${formatMoney(totalManual)}</span></div>
                <div class="bg-gray-800 p-4 rounded border border-gray-700 flex justify-between"><span>Fatura Cart√£o</span><span class="font-bold text-orange-400">${formatMoney(totalCard)}</span></div>
                <div class="bg-indigo-900 p-4 rounded border border-indigo-700 flex justify-between text-lg"><span>Saldo Final</span><span class="font-bold ${balance>=0?'text-green-300':'text-red-300'}">${formatMoney(balance)}</span></div>
            `;

            updateChart(card);
        }

        function renderList(list, elId, isCard) {
            const el = document.getElementById(elId);
            el.innerHTML = '';
            
            if(list.length === 0) {
                if(!isCard) el.innerHTML = '<div class="text-center text-gray-500 mt-4">Sem lan√ßamentos.</div>';
                return;
            }

            list.sort((a,b) => new Date(a.date) - new Date(b.date));

            list.forEach(item => {
                const day = item.date.split('-')[2];
                const catColor = getCategoryColor(item.category);
                
                el.innerHTML += `
                    <div onclick="openEdit('${item.id}')" class="expense-card bg-gray-700 p-3 rounded flex items-center justify-between border-l-4 border-[${catColor}]">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="bg-gray-800 w-10 h-10 rounded-full flex items-center justify-center text-xs font-bold text-gray-400">${day}</div>
                            <div class="min-w-0">
                                <p class="font-bold text-sm truncate text-white">${item.description}</p>
                                <p class="text-xs text-gray-400">${item.category}</p>
                            </div>
                        </div>
                        <span class="font-bold text-white whitespace-nowrap">${formatMoney(item.value)}</span>
                    </div>
                `;
            });
        }

        // --- PDF PARSER & AUTO CLASS ---
        
        document.getElementById('pdf-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            toggleLoading(true, "Lendo PDF e classificando...");
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let newItems = [];
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth()+1).padStart(2,'0');

                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const text = textContent.items.map(s => s.str).join(' ');

                    // REGEX: Tenta capturar "DD MMM Descri√ß√£o Valor" (Padr√£o Nubank/Geral)
                    // Ex: "12 ABR Uber *Trip 24,90"
                    const regex = /(\d{2})\s+(JAN|FEV|MAR|ABR|MAI|JUN|JUL|AGO|SET|OUT|NOV|DEZ)\s+(.+?)\s+(\d{1,3}(?:\.\d{3})*,\d{2})/gi;
                    
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        const day = match[1];
                        let desc = match[3].trim();
                        
                        // Ignorar linhas de pagamento da fatura anterior
                        if(desc.toUpperCase().includes('PAGAMENTO') || desc.toUpperCase().includes('TOTAL')) continue;

                        const val = parseFloat(match[4].replace('.','').replace(',','.'));
                        
                        // Auto Classifica√ß√£o
                        let cat = 'Outros';
                        const lowerDesc = desc.toLowerCase();
                        for (const [key, category] of Object.entries(KEYWORDS)) {
                            if (lowerDesc.includes(key)) {
                                cat = category;
                                break;
                            }
                        }

                        newItems.push({
                            date: `${year}-${month}-${day}`, // Assume m√™s atual da fatura
                            description: desc,
                            value: val,
                            category: cat,
                            source: 'invoice'
                        });
                    }
                }

                if(newItems.length > 0) {
                    const batch = db.batch();
                    newItems.forEach(item => {
                        const docRef = db.collection('users').doc(userId).collection('expenses').doc();
                        batch.set(docRef, item);
                    });
                    await batch.commit();
                    alert(`${newItems.length} itens importados e classificados!`);
                    loadData();
                } else {
                    alert('N√£o consegui ler itens. O PDF pode ser imagem ou formato n√£o suportado.');
                }

            } catch(e) {
                console.error(e);
                alert('Erro ao processar PDF.');
            }
            toggleLoading(false);
            document.getElementById('pdf-input').value = '';
        });

        // --- CRUD B√ÅSICO ---

        function addManualExpense() {
            const desc = prompt("Descri√ß√£o:");
            if(!desc) return;
            const val = parseFloat(prompt("Valor:"));
            if(!val) return;
            
            db.collection('users').doc(userId).collection('expenses').add({
                date: currentDate.toISOString().split('T')[0],
                description: desc,
                value: val,
                category: 'Outros',
                source: 'manual'
            }).then(loadData);
        }

        function openEdit(id) {
            currentEditId = id;
            const item = expenses.find(e => e.id === id);
            document.getElementById('edit-date').value = item.date;
            document.getElementById('edit-desc').value = item.description;
            document.getElementById('edit-cat').value = item.category;
            document.getElementById('edit-val').value = item.value;
            
            document.getElementById('edit-modal').classList.remove('hidden');
            document.getElementById('edit-modal').classList.add('flex');
        }

        document.getElementById('edit-form').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                date: document.getElementById('edit-date').value,
                description: document.getElementById('edit-desc').value,
                category: document.getElementById('edit-cat').value,
                value: parseFloat(document.getElementById('edit-val').value)
            };
            await db.collection('users').doc(userId).collection('expenses').doc(currentEditId).update(data);
            closeModal();
            loadData();
        };

        async function deleteCurrentItem() {
            if(confirm('Apagar item?')) {
                await db.collection('users').doc(userId).collection('expenses').doc(currentEditId).delete();
                closeModal();
                loadData();
            }
        }

        async function clearCardExpenses() {
            if(!confirm('Apagar TODOS os itens da Fatura deste m√™s? (Os manuais ser√£o mantidos)')) return;
            toggleLoading(true);
            const monthKey = currentDate.toISOString().slice(0, 7);
            const toDelete = expenses.filter(e => e.date.startsWith(monthKey) && e.source === 'invoice');
            
            const batch = db.batch();
            toDelete.forEach(item => batch.delete(db.collection('users').doc(userId).collection('expenses').doc(item.id)));
            await batch.commit();
            loadData();
        }

        // --- UTILIT√ÅRIOS ---

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            event.target.classList.add('active');
        }

        function updateChart(data) {
            const ctx = document.getElementById('cardChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            const cats = {};
            data.forEach(i => cats[i.category] = (cats[i.category]||0) + i.value);

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(cats),
                    datasets: [{
                        data: Object.values(cats),
                        backgroundColor: ['#f59e0b','#10b981','#a855f7','#3b82f6','#ef4444','#d946ef','#f97316','#84cc16','#6366f1','#ec4899','#14b8a6','#6b7280'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff' } } } }
            });
        }

        function getCategoryColor(cat) { return '#6366f1'; } // Simplificado
        function formatMoney(v) { return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
        function closeModal() { document.getElementById('edit-modal').classList.add('hidden'); document.getElementById('edit-modal').classList.remove('flex'); }
        function toggleLoading(show, msg) { 
            const el = document.getElementById('loading-overlay');
            el.style.display = show ? 'flex' : 'none';
            if(msg) document.getElementById('loading-text').innerText = msg;
        }

        // Eventos Renda
        async function saveIncome() {
            const monthKey = currentDate.toISOString().slice(0, 7);
            await db.collection('users').doc(userId).collection('income').doc(monthKey).set({
                s1: document.getElementById('income1').value,
                s2: document.getElementById('income2').value
            }, {merge:true});
        }
        document.getElementById('income1').onchange = saveIncome;
        document.getElementById('income2').onchange = saveIncome;

        document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); loadData(); };
        document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); loadData(); };

    </script>
</body>
</html>
